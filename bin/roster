#!/usr/bin/env node

var roster  = require('../index.js');

var argv = require('minimist')(process.argv.slice(2));

var command = argv['_'] && argv['_'][0];
var name = argv['_'] && argv['_'][1];

if (!command || !name) return usage();

function usage() {
  console.error('Usage: roster [command] user [opts]');
  // console.log('Where command is one of: ' + Object.keys(roster).join(', '))
  console.error('')
  console.error('roster exists user [opts]')
  console.error('roster groups user [opts]')
  console.error('roster create user [opts]')
  console.error('roster delete user [opts]')
  process.exit(1);
}

switch (command) {
  case 'exists':
    return roster.exists(name, function(err, bool) {
      if (err) {
        console.error(argv.json ? JSON.stringify(err) : err);
        process.exit(1)
      }
      if (argv.json) return console.log(JSON.stringify(bool))
      console.log('Exists: %s', bool);
    });
    break;

  case 'groups':
    return roster.get_groups(name, function(err, list) {
      if (err) {
        console.error(argv.json ? JSON.stringify(err) : err);
        process.exit(1)
      }
      console.log(argv.json ? JSON.stringify(list) : list);
    })

  case 'create':
    var opts = { user: name, full_name: 'John ' + name };
    return roster.create(opts, done);
    break;

  case 'remove':
  case 'delete':
    var opts = { delete_home: false };
    return roster.delete(name, opts, done);
    break;

  default:
    usage();
}

function done(err, res) {
  if (err) {
    console.error(argv.json ? JSON.stringify(err) : err);
    process.exit(1)
  }
  console.log(argv.json ? JSON.stringify(true) : 'Success!');
}
